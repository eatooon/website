# ä¸ªäººç½‘é¡µ CI/CD ç®¡é“ - GitHub Actions
name: Deploy Personal Website

# è§¦å‘æ¡ä»¶
on:
  push:
    branches: [ main, master ]  # æ¨é€åˆ°ä¸»åˆ†æ”¯æ—¶è§¦å‘
  pull_request:
    branches: [ main, master ]  # PRåˆ°ä¸»åˆ†æ”¯æ—¶è§¦å‘
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘

# æƒé™è®¾ç½®
permissions:
  contents: read
  pages: write
  id-token: write

# å¹¶å‘æ§åˆ¶ - ç¡®ä¿åªæœ‰ä¸€ä¸ªéƒ¨ç½²ä»»åŠ¡åœ¨è¿è¡Œ
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # æ„å»ºå’ŒéªŒè¯ä»»åŠ¡
  build:
    runs-on: ubuntu-latest
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: HTML è¯­æ³•æ£€æŸ¥
      run: |
        # å®‰è£… HTML éªŒè¯å·¥å…·
        npm install -g html-validate
        
        # åˆ›å»º HTML éªŒè¯é…ç½®
        cat > .htmlvalidate.json << 'EOF'
        {
          "extends": ["html-validate:recommended"],
          "rules": {
            "void-style": "omit",
            "close-order": "error",
            "no-trailing-whitespace": "off"
          }
        }
        EOF
        
        # éªŒè¯æ‰€æœ‰ HTML æ–‡ä»¶
        find . -name "*.html" -not -path "./node_modules/*" | xargs html-validate

    - name: CSS è¯­æ³•æ£€æŸ¥
      run: |
        # å®‰è£… CSS æ£€æŸ¥å·¥å…·
        npm install -g stylelint stylelint-config-standard
        
        # åˆ›å»º CSS æ£€æŸ¥é…ç½®
        cat > .stylelintrc.json << 'EOF'
        {
          "extends": "stylelint-config-standard",
          "rules": {
            "indentation": 2,
            "color-hex-case": "lower"
          }
        }
        EOF
        
        # æ£€æŸ¥æ‰€æœ‰ CSS æ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if find . -name "*.css" -not -path "./node_modules/*" | grep -q .; then
          find . -name "*.css" -not -path "./node_modules/*" | xargs stylelint
        else
          echo "æœªæ‰¾åˆ° CSS æ–‡ä»¶ï¼Œè·³è¿‡æ£€æŸ¥"
        fi

    - name: JavaScript è¯­æ³•æ£€æŸ¥
      run: |
        # å®‰è£… ESLint
        npm install -g eslint
        
        # åˆ›å»º ESLint é…ç½®
        cat > .eslintrc.json << 'EOF'
        {
          "env": {
            "browser": true,
            "es2021": true
          },
          "extends": "eslint:recommended",
          "parserOptions": {
            "ecmaVersion": 12,
            "sourceType": "module"
          }
        }
        EOF
        
        # æ£€æŸ¥æ‰€æœ‰ JS æ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if find . -name "*.js" -not -path "./node_modules/*" | grep -q .; then
          find . -name "*.js" -not -path "./node_modules/*" | xargs eslint
        else
          echo "æœªæ‰¾åˆ° JavaScript æ–‡ä»¶ï¼Œè·³è¿‡æ£€æŸ¥"
        fi

    - name: æ£€æŸ¥é“¾æ¥æœ‰æ•ˆæ€§
      run: |
        # å®‰è£…é“¾æ¥æ£€æŸ¥å·¥å…·
        npm install -g linkinator
        
        # å¯åŠ¨æœ¬åœ°æœåŠ¡å™¨è¿›è¡Œé“¾æ¥æ£€æŸ¥
        python3 -m http.server 8080 &
        SERVER_PID=$!
        sleep 3
        
        # æ£€æŸ¥å†…éƒ¨é“¾æ¥
        linkinator http://localhost:8080 --recurse --skip "mailto:|tel:|#"
        
        # æ¸…ç†
        kill $SERVER_PID

    - name: å‹ç¼©ä¼˜åŒ–èµ„æº
      run: |
        # å®‰è£…å‹ç¼©å·¥å…·
        npm install -g html-minifier-terser clean-css-cli terser
        
        # åˆ›å»º dist ç›®å½•
        mkdir -p dist
        
        # å¤åˆ¶æ‰€æœ‰æ–‡ä»¶åˆ° dist
        cp -r . dist/
        cd dist
        rm -rf .git .github node_modules .htmlvalidate.json .stylelintrc.json .eslintrc.json
        
        # å‹ç¼© HTML æ–‡ä»¶
        find . -name "*.html" -exec html-minifier-terser \
          --collapse-whitespace \
          --remove-comments \
          --remove-optional-tags \
          --remove-redundant-attributes \
          --remove-script-type-attributes \
          --remove-tag-whitespace \
          --use-short-doctype \
          --minify-css true \
          --minify-js true \
          --input {} --output {} \;
        
        # å‹ç¼© CSS æ–‡ä»¶
        find . -name "*.css" -exec cleancss -o {} {} \;
        
        # å‹ç¼© JS æ–‡ä»¶
        find . -name "*.js" -exec terser {} -o {} -c -m \;
        
        echo "èµ„æºå‹ç¼©å®Œæˆ"

    - name: ç”Ÿæˆéƒ¨ç½²æŠ¥å‘Š
      run: |
        echo "## ğŸš€ éƒ¨ç½²æŠ¥å‘Š" > deploy-report.md
        echo "- æ„å»ºæ—¶é—´: $(date)" >> deploy-report.md
        echo "- æäº¤å“ˆå¸Œ: $GITHUB_SHA" >> deploy-report.md
        echo "- åˆ†æ”¯: $GITHUB_REF_NAME" >> deploy-report.md
        
        # ç»Ÿè®¡æ–‡ä»¶ä¿¡æ¯
        echo "- HTML æ–‡ä»¶æ•°é‡: $(find dist -name "*.html" | wc -l)" >> deploy-report.md
        echo "- CSS æ–‡ä»¶æ•°é‡: $(find dist -name "*.css" | wc -l)" >> deploy-report.md
        echo "- JS æ–‡ä»¶æ•°é‡: $(find dist -name "*.js" | wc -l)" >> deploy-report.md
        echo "- å›¾ç‰‡æ–‡ä»¶æ•°é‡: $(find dist -name "*.jpg" -o -name "*.png" -o -name "*.gif" -o -name "*.svg" | wc -l)" >> deploy-report.md
        
        cat deploy-report.md

    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-pages-artifact@v3
      with:
        path: ./dist

  # éƒ¨ç½²åˆ° GitHub Pages
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    steps:
    - name: éƒ¨ç½²åˆ° GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

# å¯é€‰ï¼šæ·»åŠ é€šçŸ¥ä»»åŠ¡
  notify:
    runs-on: ubuntu-latest
    needs: [build, deploy]
    if: always() && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    steps:
    - name: éƒ¨ç½²çŠ¶æ€é€šçŸ¥
      run: |
        if [ "${{ needs.deploy.result }}" == "success" ]; then
          echo "âœ… ç½‘ç«™éƒ¨ç½²æˆåŠŸï¼"
          echo "ğŸŒ è®¿é—®åœ°å€: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
        else
          echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
        fi
